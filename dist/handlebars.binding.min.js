// handlebars.binding
// ------------------
// v0.1.5
//
// Copyright (c) 2013-2015 Mateus Maso
// Distributed under MIT license
//
// http://github.com/mateusmaso/handlebars.binding

!function(a,b){"undefined"!=typeof exports?("undefined"!=typeof module&&module.exports&&(module.exports=b(global.Handlebars)),exports=b(global.Handlebars)):b(a.Handlebars)}(this,function(a){var b=a.Utils;a.Utils.isFalsy=function(a){return!a||b.isEmpty(a)},a.Utils.hasClass=function(a,b){return a.className.match(new RegExp("(\\s|^)"+b+"(\\s|$)"))},a.Utils.addClass=function(a,c){return b.hasClass(a,c)?void 0:0==a.className.length?a.className=c:a.className+=" "+c},a.Utils.removeClass=function(a,c){return b.hasClass(a,c)?a.className=a.className.replace(new RegExp("(\\s|^)"+c+"(\\s|$)"),""):void 0},a.Utils.nodesBetween=function(a,b){for(var c=a.nextSibling,d=[];c&&c!=b;){var e=c.nextSibling;d.push(c),c=e}return d},a.Utils.removeBetween=function(c,d){for(var e=b.nodesBetween(c,d),f=0;f<e.length;f++){var g=e[f];a.unbind(g),g.remove()}},a.Utils.traverse=function(a,c){for(c.apply(this,[a]),a=a.firstChild;a;)b.traverse(a,c),a=a.nextSibling},a.Utils.path=function(a,b){for(var c=b.split("."),d=a[c.shift()],e=0;e<c.length;e++)d=d[c[e]];return d},a.Binding=function(a,c,d,e){this.id=b.uniqueId(),this.node,this.nodes=[],this.attribute,this.output,this.previousOutput,this.context=a,this.keypath=c,this.options=e,this.value=d,c&&(this.value=b.path(this.context,this.keypath)),this.marker=document.createTextNode(""),this.marker.binding=this,this.delimiter=document.createTextNode(""),this.render()},a.Binding.prototype.initialize=function(){var a;return a=this.options.hash.attr?this.initializeAttribute():this.options.fn?this.initializeBlock():this.initializeInline(),this.observe(),a},a.Binding.prototype.render=function(){return this.options.fn?this.setOutput(this.options.fn(this.context)):this.setOutput(this.value)},a.Binding.prototype.initializeAttribute=function(){var c="binding-"+this.id;return a.registerAttribute(c,function(a){return 1==this.options.hash.attr?(this.attribute=document.createAttribute(this.value),this.attribute):"class"!=this.options.hash.attr?(this.attribute=document.createAttribute(this.options.hash.attr),this.attribute.value=this.value,this.attribute):(this.attribute=a.attributes["class"],void b.addClass(a,this.value))}.bind(this),{ready:function(b){this.setNode(b),delete a.attributes[c]}.bind(this)}),this.createAttribute()},a.Binding.prototype.initializeInline=function(){return b.isString(this.value)?this.setNode(document.createTextNode(b.escapeExpression(new a.SafeString(this.output)))):this.setNode(document.createTextNode(b.escapeExpression(this.output))),a.store.hold(this.id,b.flatten([this.node])),new a.SafeString(this.createElement())},a.Binding.prototype.initializeBlock=function(){return this.nodes=a.parseHTML(this.output),a.store.hold(this.id,b.flatten([this.marker,this.nodes,this.delimiter])),new a.SafeString(this.createElement())},a.Binding.prototype.observe=function(){b.isArray(this.value)?(this.observer=new ArrayObserver(this.value),this.observer.open(function(){this.render(),this.react()}.bind(this))):b.isObject(this.value)?(this.observer=new ObjectObserver(this.value),this.observer.open(function(){this.render(),this.react()}.bind(this))):(this.observer=new PathObserver(this.context,this.keypath),this.observer.open(function(a){this.value=a,this.render(),this.react()}.bind(this)))},a.Binding.prototype.stopObserving=function(){this.observer.close()},a.Binding.prototype.react=function(){this.options.hash.attr?1==this.options.hash.attr?(this.node.removeAttribute(this.previousOutput),this.node.setAttribute(this.output,"")):"class"==this.options.hash.attr?(b.removeClass(this.node,this.previousOutput),b.addClass(this.node,this.output)):this.node.setAttribute(this.options.hash.attr,this.output):this.options.fn?(this.nodes=a.parseHTML(this.output),b.removeBetween(this.marker,this.delimiter),b.insertAfter(this.marker,this.nodes)):b.isString(this.output)?this.node.textContent=b.escapeExpression(new a.SafeString(this.output)):this.node.textContent=b.escapeExpression(this.output)},a.Binding.prototype.setOutput=function(a){this.previousOutput=this.output,this.output=a},a.Binding.prototype.setNode=function(a){this.node=a,this.node.bindings=this.node.bindings||[],this.node.bindings.push(this)},a.Binding.prototype.createElement=function(){return"<hb-binding id='"+this.id+"'></hb-binding>"},a.Binding.prototype.createAttribute=function(){return"hb-binding-"+this.id},a.IfBinding=function(c,d,e,f){return this.falsy=b.isFalsy(e),a.Binding.apply(this,arguments)},a.IfBinding.prototype=Object.create(a.Binding.prototype),a.IfBinding.prototype.initializeAttribute=function(){var c="binding-"+this.id;return a.registerAttribute(c,function(a){if(1==this.options.hash.attr){if(this.output&&(this.attribute=document.createAttribute(this.output)),this.attribute)return this.attribute}else{if("class"!=this.options.hash.attr)return this.attribute=document.createAttribute(this.options.hash.attr),this.attribute.value=this.output,this.attribute;this.attribute=a.attributes["class"],this.output&&b.addClass(a,this.output)}}.bind(this),{ready:function(b){this.setNode(b),delete a.attributes[c]}.bind(this)}),this.createAttribute()},a.IfBinding.prototype.render=function(){this.falsy?this.setOutput(this.options.inverse?this.options.inverse(this.context):this.options.hash["else"]):this.setOutput(this.options.fn?this.options.fn(this.context):this.options.hash.then)},a.IfBinding.prototype.observe=function(){b.isArray(this.conditional)?(this.observer=new ArrayObserver(this.conditional),this.observer.open(function(){b.isFalsy(this.conditional)!=this.falsy&&(this.falsy=b.isFalsy(this.conditional),this.render(),this.react())}.bind(this))):(this.observer=new PathObserver(this.context,this.keypath),this.observer.open(function(a){this.conditional=a,b.isFalsy(this.conditional)!=this.falsy&&(this.falsy=b.isFalsy(this.conditional),this.render(),this.react())}.bind(this)))},a.EachBinding=function(b,c,d,e){return this.markers=[],this.delimiters=[],this.empty=0==d.length,a.Binding.apply(this,arguments)},a.EachBinding.prototype=Object.create(a.Binding.prototype),a.EachBinding.prototype.observe=function(){this.observer=new ArrayObserver(this.value),this.observer.open(function(a){for(var b=0;b<a.length;b++)this.react(a[b])}.bind(this))},a.EachBinding.prototype.react=function(c){if(0!=this.value.length||this.empty||(this.empty=!0,this.render(),b.insertAfter(this.marker,a.parseHTML(this.output))),this.value.length>0&&this.empty&&(this.empty=!1,b.removeBetween(this.marker,this.delimiter)),c.removed.length>0){for(var d=c.index;d<c.index+c.removed.length;d++)b.removeBetween(this.markers[d],this.delimiters[d]),this.markers[d].remove(),this.delimiters[d].remove();for(var d=c.index;d<c.index+c.removed.length;d++)this.markers.splice(d,1),this.delimiters.splice(d,1)}if(c.addedCount>0)for(var d=c.index;d<c.index+c.addedCount;d++){var e=this.value[d],f=document.createTextNode(""),g=document.createTextNode(""),h=a.parseHTML(this.renderItem(e,d)),i=this.delimiters[d-1]||this.marker;b.insertAfter(i,b.flatten([f,h,g])),this.markers.splice(d,0,f),this.delimiters.splice(d,0,g)}},a.EachBinding.prototype.render=function(){for(var a="",b=0;b<this.value.length;b++)a+=this.renderItem(this.value[b],b);this.setOutput(this.value.length?a:this.options.inverse(this.context))},a.EachBinding.prototype.renderItem=function(a,c){var d=b.extend({index:c},this.context);return this.options.hash["var"]?d[this.options.hash["var"]]=a:d=b.extend(d,a),this.options.fn(d)},a.EachBinding.prototype.initializeBlock=function(){for(var c=0;c<this.value.length;c++){var d=this.value[c],e=document.createTextNode(""),f=document.createTextNode(""),g=a.parseHTML(this.renderItem(d,c));this.markers.push(e),this.delimiters.push(f),this.nodes.push(e,g,f)}return this.nodes=b.flatten(this.nodes),a.store.hold(this.id,b.flatten([this.marker,this.empty?a.parseHTML(this.output):this.nodes,this.delimiter])),new a.SafeString(this.createElement())},a.bind=function(a){b.traverse(a,function(a){if(a.binding)a.binding.observe();else if(a.bindings)for(var b=0;b<a.bindings.length;b++)a.bindings[b].observe()})},a.unbind=function(a){b.traverse(a,function(a){if(a.binding)a.binding.stopObserving();else if(a.bindings)for(var b=0;b<a.bindings.length;b++)a.bindings[b].stopObserving()})},a.registerHelper("bind",function(b,c){var d=new a.Binding(this,b,null,c);return d.initialize()}),a.registerHelper("if",function(c,d){var e;d.hash.bindAttr&&(d.hash.attr=d.hash.bindAttr,d.hash.bind=!0),d.hash.bind&&b.isString(c)&&(e=c,c=b.path(this,e));var f=new a.IfBinding(this,e,c,d);return d.hash.bind?f.initialize():f.output}),a.registerHelper("unless",function(b,c){var d=c.fn,e=c.inverse,f=c.hash.then,g=c.hash["else"];return c.fn=e,c.inverse=d,c.hash.then=g,c.hash["else"]=f,a.helpers["if"].apply(this,[b,c])}),a.registerHelper("each",function(b,c){var d=new a.EachBinding(this,null,b,c);return c.hash.bind?d.initialize():d.output}),a.registerElement("binding",function(a){return a.id})});