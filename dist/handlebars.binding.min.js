// handlebars.binding
// ------------------
// v0.2.0
//
// Copyright (c) 2013-2016 Mateus Maso
// Distributed under MIT license
//
// http://github.com/mateusmaso/handlebars.binding

!function(a,b){"undefined"!=typeof exports?("undefined"!=typeof module&&module.exports&&(module.exports=b(global.Handlebars)),exports=b(global.Handlebars)):b(a.Handlebars)}(this,function(a){var b=a.Utils;a.Utils.isFalsy=function(a){return!a||b.isEmpty(a)},a.Utils.hasClass=function(a,b){return a.className.match(new RegExp("(\\s|^)"+b+"(\\s|$)"))},a.Utils.addClass=function(a,c){return b.hasClass(a,c)?void 0:0==a.className.length?a.className=c:a.className+=" "+c},a.Utils.removeClass=function(a,c){return b.hasClass(a,c)?a.className=a.className.replace(new RegExp("(\\s|^)"+c+"(\\s|$)"),""):void 0},a.Utils.nodesBetween=function(a,b){for(var c=a.nextSibling,d=[];c&&c!=b;){var e=c.nextSibling;d.push(c),c=e}return d},a.Utils.removeBetween=function(c,d){for(var e=b.nodesBetween(c,d),f=0;f<e.length;f++){var g=e[f];a.unbind(g),g.remove()}},a.Utils.traverse=function(a,c){for(c.apply(this,[a]),a=a.firstChild;a;)b.traverse(a,c),a=a.nextSibling},a.Utils.path=function(a,b){for(var c=b.split("."),d=a[c.shift()],e=0;e<c.length;e++)d=d[c[e]];return d},a.Binding=function(a,c,d,e){this.id=b.uniqueId(),this.node,this.observer,this.output,this.previousOutput,this.context=a,this.keypath=c,this.options=e,this.value=d,c&&(this.value=b.path(this.context,this.keypath)),this.marker=document.createTextNode(""),this.delimiter=document.createTextNode(""),this.render()},a.Binding.prototype.initialize=function(){if(this.options.hash.attr){var c="binding-"+this.id;return a.registerAttribute(c,function(a){return this.initializeAttribute(a)}.bind(this),{ready:function(b){this.observe(),this.setNode(b),delete a.attributes[c]}.bind(this)}),this.createAttribute()}if(this.options.fn){var d=this.initializeBlock();return this.observe(),this.marker.binding=this,a.store.hold(this.id,b.flatten([this.marker,d,this.delimiter])),new a.SafeString(this.createElement())}return this.observe(),this.setNode(this.initializeInline()),a.store.hold(this.id,b.flatten([this.node])),new a.SafeString(this.createElement())},a.Binding.prototype.render=function(){return this.options.fn?this.setOutput(this.options.fn(this.context)):this.setOutput(this.value)},a.Binding.prototype.initializeAttribute=function(a){if(1==this.options.hash.attr)return document.createAttribute(this.value);if("class"==this.options.hash.attr)return b.addClass(a,this.value),a.attributes["class"];var c=document.createAttribute(this.options.hash.attr);return c.value=this.value,c},a.Binding.prototype.initializeInline=function(){return b.isString(this.value)?document.createTextNode(b.escapeExpression(new a.SafeString(this.output))):document.createTextNode(b.escapeExpression(this.output))},a.Binding.prototype.initializeBlock=function(){return a.parseHTML(this.output)},a.Binding.prototype.observe=function(){b.isArray(this.value)?(this.observer=new ArrayObserver(this.value),this.observer.open(function(){this.render(),this.react()}.bind(this))):b.isObject(this.value)?(this.observer=new ObjectObserver(this.value),this.observer.open(function(){this.render(),this.react()}.bind(this))):(this.observer=new PathObserver(this.context,this.keypath),this.observer.open(function(a){this.value=a,this.render(),this.react()}.bind(this)))},a.Binding.prototype.stopObserving=function(){this.observer.close()},a.Binding.prototype.react=function(){this.options.hash.attr?1==this.options.hash.attr?(this.node.removeAttribute(this.previousOutput),this.node.setAttribute(this.output,"")):"class"==this.options.hash.attr?(b.removeClass(this.node,this.previousOutput),b.addClass(this.node,this.output)):this.node.setAttribute(this.options.hash.attr,this.output):this.options.fn?(b.removeBetween(this.marker,this.delimiter),b.insertAfter(this.marker,a.parseHTML(this.output))):b.isString(this.output)?this.node.textContent=b.escapeExpression(new a.SafeString(this.output)):this.node.textContent=b.escapeExpression(this.output)},a.Binding.prototype.setNode=function(a){return a.bindings=a.bindings||[],a.bindings.push(this),this.node=a},a.Binding.prototype.setOutput=function(a){return this.previousOutput=this.output,this.output=a},a.Binding.prototype.createElement=function(){return"<hb-binding id='"+this.id+"'></hb-binding>"},a.Binding.prototype.createAttribute=function(){return"hb-binding-"+this.id},a.IfBinding=function(c,d,e,f){return this.falsy=b.isFalsy(e),a.Binding.apply(this,arguments)},a.IfBinding.prototype=Object.create(a.Binding.prototype),a.IfBinding.prototype.initializeAttribute=function(a){if(1!=this.options.hash.attr){if("class"==this.options.hash.attr)return this.output&&b.addClass(a,this.output),a.attributes["class"];var c=document.createAttribute(this.options.hash.attr);return c.value=this.output,c}return this.output?document.createAttribute(this.output):void 0},a.IfBinding.prototype.react=function(){return this.options.hash.attr&&1==this.options.hash.attr?(this.node.removeAttribute(this.previousOutput),void(this.output&&this.node.setAttribute(this.output,""))):a.Binding.prototype.react.apply(this,arguments)},a.IfBinding.prototype.render=function(){this.falsy?this.setOutput(this.options.inverse?this.options.inverse(this.context):this.options.hash["else"]):this.setOutput(this.options.fn?this.options.fn(this.context):this.options.hash.then)},a.IfBinding.prototype.observe=function(){b.isArray(this.value)?(this.observer=new ArrayObserver(this.value),this.observer.open(function(){b.isFalsy(this.value)!=this.falsy&&(this.falsy=b.isFalsy(this.value),this.render(),this.react())}.bind(this))):(this.observer=new PathObserver(this.context,this.keypath),this.observer.open(function(a){this.value=a,b.isFalsy(this.value)!=this.falsy&&(this.falsy=b.isFalsy(this.value),this.render(),this.react())}.bind(this)))},a.EachBinding=function(b,c,d,e){return this.markers=[],this.delimiters=[],this.empty=0==d.length,a.Binding.apply(this,arguments)},a.EachBinding.prototype=Object.create(a.Binding.prototype),a.EachBinding.prototype.observeItem=function(a,c){var d,e=c.context;b.isObject(a)?this.options.hash["var"]||(d=new ObjectObserver(a),d.open(function(){b.extend(e,a)}.bind(this))):(d=new ArrayObserver(this.value),d.open(function(){a=this.value[e.index],e.$this=a,this.options.hash["var"]&&(e[this.options.hash["var"]]=a)}.bind(this)));var f=new ObjectObserver(this.context);f.open(function(){b.extend(e,this.context)}.bind(this))},a.EachBinding.prototype.observe=function(){this.observer=new ArrayObserver(this.value),this.observer.open(function(a){for(var b=0;b<a.length;b++)this.react(a[b]);for(var b=0;b<this.value.length;b++)this.markers[b].context.index=b}.bind(this));for(var a=0;a<this.value.length;a++)this.observeItem(this.value[a],this.markers[a])},a.EachBinding.prototype.react=function(c){if(0!=this.value.length||this.empty||(this.empty=!0,this.render(),b.insertAfter(this.marker,a.parseHTML(this.output))),this.value.length>0&&this.empty&&(this.empty=!1,b.removeBetween(this.marker,this.delimiter)),c.removed.length>0)for(var d=0,e=c.index;e<c.index+c.removed.length;e++){var f=e-d++;b.removeBetween(this.markers[f],this.delimiters[f]),this.markers[f].remove(),this.delimiters[f].remove(),this.markers.splice(f,1),this.delimiters.splice(f,1)}if(c.addedCount>0)for(var e=c.index;e<c.index+c.addedCount;e++){var g=this.value[e],h=document.createTextNode(""),i=document.createTextNode(""),j=a.parseHTML(this.renderItem(g,e,h)),k=this.delimiters[e-1]||this.marker;b.insertAfter(k,b.flatten([h,j,i])),this.markers.splice(e,0,h),this.delimiters.splice(e,0,i),this.observeItem(g,h)}},a.EachBinding.prototype.render=function(){for(var a="",b=0;b<this.value.length;b++)a+=this.renderItem(this.value[b],b);this.setOutput(this.value.length?a:this.options.inverse(this.context))},a.EachBinding.prototype.renderItem=function(a,c,d){var e=b.extend({index:c,$this:a},this.context);return this.options.hash["var"]?e[this.options.hash["var"]]=a:b.isObject(a)&&b.extend(e,a),null!=d&&(d.context=e),this.options.fn(e)},a.EachBinding.prototype.initializeBlock=function(){if(this.empty)return a.parseHTML(this.output);for(var c=[],d=0;d<this.value.length;d++){var e=this.value[d],f=document.createTextNode(""),g=document.createTextNode(""),h=a.parseHTML(this.renderItem(e,d,f));this.markers.push(f),this.delimiters.push(g),c.push(f,h,g)}return b.flatten(c)},a.bind=function(a){b.traverse(a,function(a){if(a.binding)a.binding.observe();else if(a.bindings)for(var b=0;b<a.bindings.length;b++)a.bindings[b].observe()})},a.unbind=function(a){b.traverse(a,function(a){if(a.binding)a.binding.stopObserving();else if(a.bindings)for(var b=0;b<a.bindings.length;b++)a.bindings[b].stopObserving()})},a.registerHelper("bind",function(b,c){var d=new a.Binding(this,b,null,c);return d.initialize()}),a.registerHelper("if",function(c,d){var e;d.hash.bindAttr&&(d.hash.attr=d.hash.bindAttr,d.hash.bind=!0),d.hash.bind&&b.isString(c)&&(e=c,c=b.path(this,e));var f=new a.IfBinding(this,e,c,d);return d.hash.bind?f.initialize():f.output}),a.registerHelper("unless",function(b,c){var d=c.fn,e=c.inverse,f=c.hash.then,g=c.hash["else"];return c.fn=e,c.inverse=d,c.hash.then=g,c.hash["else"]=f,a.helpers["if"].apply(this,[b,c])}),a.registerHelper("each",function(b,c){var d=new a.EachBinding(this,null,b,c);return c.hash.bind?d.initialize():d.output}),a.registerElement("binding",function(a){return a.id})});